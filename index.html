<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Autoatendimento - Safe Totem</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
      html, body {
        height: 100%;
        width: 100%;
        margin: 0;
        padding: 0;
      }

      html {
        background: url('/safe_totem/safe_atendimento/frontend/public/BG Vertical.jpg') no-repeat center center fixed, linear-gradient(135deg, #1d4ed8 0%, #ffffff 100%);
        background-size: cover;
      }
      body {
        min-height: 100vh;
        min-width: 100vw;
        height: 100vh;
        width: 100vw;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: 'SF Pro Display', 'Inter', Arial, sans-serif;
        background: transparent;
      }
      .card {
        border-radius: 32px;
        padding: 80px 48px;
        background: rgba(255, 255, 255, 0.25);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: 1.5px solid rgba(255, 255, 255, 0.25);
        display: flex;
        flex-direction: column;
        align-items: center;
        max-width: 800px;
        width: 100%;
        transition: box-shadow 0.3s;
      }
      .card:hover {
        box-shadow: 0 16px 48px 0 rgba(31, 38, 135, 0.28);
      }
      .logo {
        font-size: 72px;
        font-weight: 800;
        color: #fff;
        padding-bottom: 48px;
      }
      .title {
        color: #0f0f0f;
        font-size: 40px;
        font-weight: 700;
        margin-bottom: 36px;
        text-align: center;
        letter-spacing: 1px;
      }
      .input {
        width: 90%;
        margin-left: auto;
        margin-right: auto;
        display: block;
        padding: 24px 48px;
        border-radius: 12px;
        border: none;
        font-size: 28px;
        margin-bottom: 28px;
        outline: auto;
        background: rgba(255,255,255,0.7);
        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        transition: box-shadow 0.2s, background 0.2s;
      }
      .input:focus {
        box-shadow: 0 4px 16px rgba(23,137,255,0.15);
        background: #fff;
      }
      .input::placeholder {
        color: #b0b0b0;
        opacity: 1;
      }
      .button {
        background: linear-gradient(90deg, #3b82f6 0%, #EC297B 100%);
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: 24px 56px;
        font-size: 28px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 16px;
        box-shadow: 0 2px 8px rgba(23,137,255,0.10);
        transition: background 0.2s, box-shadow 0.2s, transform 0.1s;
        margin-left: auto;
        margin-right: auto;
        display: block;
      }
      .button:hover {
        background: linear-gradient(90deg, #EC297B 0%, #3b82f6 100%);
        box-shadow: 0 6px 24px rgba(236,41,123,0.12);
        transform: translateY(-2px) scale(1.03);
      }
      .button-outline {
        background: transparent;
        color: #3b82f6;
        border: 2px solid #3b82f6;
        border-radius: 12px;
        padding: 24px 56px;
        margin: 0 36px;
        font-size: 28px;
        font-weight: 700;
        cursor: pointer;
        margin-top: 16px;
        width: 90%;
        display: block;
        transition: border 0.2s, color 0.2s, background 0.2s;
      }
      .button-outline:hover {
        background: #f0f8ff;
        color: #EC297B;
        border-color: #EC297B;
      }
      .button-group {
        width: 90%;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 16px;
      }
      .button,
      .button-outline {
        width: 90%;
        display: block;
        box-sizing: border-box;
      }
      .senha-box {
        background: #fff;
        color: #3b82f6;
        font-size: 64px;
        font-weight: 900;
        border-radius: 20px;
        padding: 36px 72px;
        margin: 36px 0 20px 0;
        box-shadow: 0 6px 24px rgba(23, 137, 255, 0.12);
        letter-spacing: 2px;
      }
      .info {
        color: #222;
        font-size: 26px;
        margin-bottom: 28px;
        text-align: center;
        background: rgba(255,255,255,0.5);
        border-radius: 12px;
        padding: 16px 0;
      }
      .error {
        color: #ff5252;
        margin-top: 20px;
        font-size: 24px;
        text-align: center;
        background: rgba(255,255,255,0.7);
        border-radius: 8px;
        padding: 8px 0;
      }
      @media (max-width: 600px) {
        .card {
          padding: 32px 8px;
        }
        .logo img {
          max-width: 90vw !important;
        }
        .title {
          font-size: 28px;
        }
        .input, .button {
          font-size: 20px;
          padding: 16px 8px;
        }
        .senha-box {
          font-size: 36px;
          padding: 16px 12px;
        }
        .info {
          font-size: 18px;
        }
      }
      @media (max-width: 900px) {
        .card {
          max-width: 98vw;
          padding: 32px 8px;
        }
      }
    </style>
  </head>
  <body>
    <div class="card" id="app"></div>
    <script>
      let step = 0;
      let nome = "";
      let senha = "";
      let paciente = null;
      let consulta = null;
      let consultasSOC = [];
      let filaSemAgendamento = [];

      // Usando backend Node.js hospedado no Railway
      const SOC_URL = "https://safeatendimento-production.up.railway.app/api/soc";

      function gerarSenhaAleatoria() {
        const letra = String.fromCharCode(65 + Math.floor(Math.random() * 3));
        const numero = (100 + Math.floor(Math.random() * 900)).toString();
        return letra + numero;
      }

      function formatarDataHora(dataISO) {
        if (!dataISO) return "";
        const data = new Date(dataISO);
        if (isNaN(data.getTime())) return dataISO;
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        const hora = String(data.getHours()).padStart(2, '0');
        const min = String(data.getMinutes()).padStart(2, '0');
        return `${dia}/${mes}/${ano} ${hora}:${min}`;
      }

      // Garantir que só a data apareça no campo Horário:
      function formatarData(dataISO) {
        if (!dataISO) return "";
        // Tenta extrair só a parte da data se vier no formato 'YYYY-MM-DD' ou 'YYYY-MM-DDTHH:mm:ss'
        const match = dataISO.match(/(\d{4}-\d{2}-\d{2})/);
        let dataStr = match ? match[1] : dataISO;
        const data = new Date(dataStr);
        if (isNaN(data.getTime())) return dataStr;
        const dia = String(data.getDate()).padStart(2, '0');
        const mes = String(data.getMonth() + 1).padStart(2, '0');
        const ano = data.getFullYear();
        return `${dia}/${mes}/${ano}`;
      }

      function gerarSenhaSemAgendamento() {
        // Gera senha única do tipo S12345 (S + 5 dígitos aleatórios)
        let senha;
        do {
          senha = 'S' + Math.floor(10000 + Math.random() * 90000); // 5 dígitos
        } while (window.ultimasSenhasSemAgendamento && window.ultimasSenhasSemAgendamento.includes(senha));
        // Armazena últimas senhas geradas na sessão para evitar duplicidade
        if (!window.ultimasSenhasSemAgendamento) window.ultimasSenhasSemAgendamento = [];
        window.ultimasSenhasSemAgendamento.push(senha);
        if (window.ultimasSenhasSemAgendamento.length > 100) window.ultimasSenhasSemAgendamento.shift();
        return senha;
      }

      async function registrarSenhaSemAgendamento(senha) {
        try {
          const res = await fetch('https://safeatendimento-production.up.railway.app/api/senhas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ senha }) // Não envia nome!
          });
          if (!res.ok) throw new Error('Erro ao registrar senha no backend');
          return true;
        } catch (e) {
          return false;
        }
      }

      function render() {
        const app = document.getElementById("app");
        if (step === 0) {
          app.innerHTML = `
          <div class="logo">
            <img src="/safe_totem/safe_atendimento/frontend/public/Vector.svg" alt="Safe Totem" style="max-width: 800px; width: 100%; height: auto;" />
          </div>
          <div class="title">Bem-vindo ao Autoatendimento</div>
          <button class="button" onclick="proximoPasso()">Iniciar atendimento</button>
        `;
        } else if (step === 1) {
          app.innerHTML = `
          <div class="title">Digite seu CPF</div>
          <input class="input" id="cpfInput" placeholder="Digite seu CPF" maxlength="14" />
          <button class="button" onclick="buscarPorCPF()">Buscar</button>
          <div class="error" id="erro"></div>
        `;
          document.getElementById("cpfInput").focus();
        } else if (step === 2 && paciente && consulta) {
          app.innerHTML = `
          <div class="title">Confirme seus dados</div>
          <div class="info">
            <b>Nome:</b> ${paciente.NOMEFUNCIONARIO}<br>
            <b>CPF:</b> ${paciente.CPFFUNCIONARIO}<br>
            <b>Horário:</b> ${formatarData(consulta.DATACOMPROMISSO)}
          </div>
          <div class="button-group">
            <button class="button" onclick="confirmarAtendimento()">Confirmar e gerar senha</button>
            <button class="button-outline" onclick="voltarInicio()">Voltar</button>
          </div>
        `;
        } else if (step === 3 && senha) {
          app.innerHTML = `
          <div class="title">Sua senha de atendimento</div>
          <div class="senha-box">${senha}</div>
          <div class="info">Por favor, aguarde ser chamado no painel.<br>Obrigado!</div>
          <button class="button" onclick="voltarInicio()">Novo atendimento</button>
        `;
        } else if (step === 4) {
          // Tela para cadastrar pessoa não encontrada no SOC
          app.innerHTML = `
          <div class="title">Digite seus dados</div>
          <input class="input" id="cpfCadastroInput" placeholder="CPF" maxlength="14" value="${window.cpfNaoEncontrado || ''}" />
          <input class="input" id="nomeInput" placeholder="Nome completo" />
          <button class="button" onclick="confirmarCadastro()">Confirmar e gerar senha</button>
          <button class="button-outline" onclick="voltarInicio()">Voltar</button>
          <div class="error" id="erroCadastro"></div>
        `;
          document.getElementById("nomeInput").focus();
        }
      }

      function proximoPasso() {
        step = 1;
        render();
      }

      async function buscarPorCPF() {
        const cpf = document.getElementById("cpfInput").value.trim();
        document.getElementById("erro").innerText = "";
        
        if (!cpf) {
          document.getElementById("erro").innerText = "Digite um CPF válido.";
          return;
        }

        // Carregar dados do SOC se ainda não carregou
        if (consultasSOC.length === 0) {
          try {
            const res = await fetch(SOC_URL);
            consultasSOC = await res.json();
          } catch (e) {
            document.getElementById("erro").innerText = "Erro ao buscar dados do SOC.";
            return;
          }
        }

        // Normalizar CPF para apenas números
        const cpfLimpo = cpf.replace(/\D/g, "");

        // Buscar por CPF
        const consultasPaciente = consultasSOC.filter((c) => {
          const cpfConsulta = c.CPFFUNCIONARIO ? c.CPFFUNCIONARIO.toString().replace(/\D/g, "") : "";
          return cpfConsulta === cpfLimpo;
        });

        if (consultasPaciente.length === 0) {
          // CPF não encontrado no SOC - vai para tela de cadastro
          window.cpfNaoEncontrado = cpf;
          step = 4;
          render();
        } else {
          // CPF encontrado - mostra dados do agendamento
          paciente = consultasPaciente[0];
          consulta = consultasPaciente[0];
          step = 2;
          render();
        }
      }

      async function confirmarCadastro() {
        const nome = document.getElementById("nomeInput").value.trim();
        const cpf = document.getElementById("cpfCadastroInput").value.trim();
        
        if (!nome || !cpf) {
          document.getElementById("erroCadastro").innerText = "Preencha todos os campos.";
          return;
        }

        // Gera senha para pessoa sem agendamento (com 'S')
        const senhaGerada = gerarSenhaSemAgendamento();
        
        try {
          const res = await fetch('https://safeatendimento-production.up.railway.app/api/senhas', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
              senha: senhaGerada,
              nome: nome,
              cpf: cpf
            })
          });
          
          if (res.ok) {
            senha = senhaGerada;
            step = 3;
            render();
          } else {
            document.getElementById("erroCadastro").innerText = "Erro ao gerar senha. Tente novamente.";
          }
        } catch (e) {
          document.getElementById("erroCadastro").innerText = "Erro ao gerar senha. Tente novamente.";
        }
      }

      async function confirmarAtendimento() {
        // Usa o código do funcionário do SOC como senha
        senha = paciente.CODIGOFUNCIONARIO || "N/A";
        console.log("Enviando para backend:", {
          senha,
          nome: paciente.NOMEFUNCIONARIO,
          cpf: paciente.CPFFUNCIONARIO,
        });

        try {
          await fetch(
            "https://safeatendimento-production.up.railway.app/api/senhas",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                senha: senha,
                nome: paciente.NOMEFUNCIONARIO,
                cpf: paciente.CPFFUNCIONARIO,
              }),
            }
          );
          // erro silencioso
        } catch (e) {
          // erro silencioso
        }
        step = 3;
        render();
      }

      function voltarInicio() {
        step = 0;
        nome = "";
        senha = "";
        paciente = null;
        consulta = null;
        window.cpfNaoEncontrado = null;
        render();
      }

      function voltarInicioSemAgendamento() {
        step = 0;
        window.senhaSemAgendamentoAtual = null;
        window.senhaSemAgendamentoRegistrada = false;
        window.cpfNaoEncontrado = null;
        render();
      }

      function abrirCadastroAtendente() {
        step = 6;
        render();
      }

      function mostrarModalSenha(senha, callback) {
        // Cria o modal
        let modal = document.createElement('div');
        modal.id = 'modalSenha';
        modal.style.position = 'fixed';
        modal.style.top = '0';
        modal.style.left = '0';
        modal.style.width = '100vw';
        modal.style.height = '100vh';
        modal.style.background = 'rgba(0,0,0,0.4)';
        modal.style.display = 'flex';
        modal.style.alignItems = 'center';
        modal.style.justifyContent = 'center';
        modal.style.zIndex = '9999';
        modal.innerHTML = `
          <div style="background: #fff; border-radius: 24px; padding: 48px 32px; box-shadow: 0 8px 32px rgba(0,0,0,0.18); text-align: center; min-width: 320px;">
            <div style="font-size: 32px; font-weight: bold; color: #3b82f6; margin-bottom: 24px;">Senha gerada</div>
            <div style="font-size: 48px; font-weight: 900; color: #EC297B; margin-bottom: 32px;">${senha}</div>
            <button id="fecharModalSenha" class="button" style="max-width: 200px;">OK</button>
          </div>
        `;
        document.body.appendChild(modal);
        document.getElementById('fecharModalSenha').onclick = function() {
          document.body.removeChild(modal);
          if (callback) callback();
        };
      }

      async function registrarSemAgendamento() {
        // Atualiza nome e cpf do primeiro da fila
        const nome = document.getElementById('nomeCadastroInput').value.trim();
        const cpf = document.getElementById('cpfCadastroInput').value.trim();
        const senha = document.getElementById('senhaInput').value.trim();
        if (!nome || !cpf) {
          alert('Preencha nome e CPF!');
          return;
        }
        filaSemAgendamento[0].nome = nome;
        filaSemAgendamento[0].cpf = cpf;
        // Envia para o backend
        try {
          await fetch('https://safeatendimento-production.up.railway.app/api/usuarios', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ senha, nome, cpf })
          });
        } catch (e) {
          alert('Erro ao cadastrar no backend!');
          return;
        }
        // Mostra modal com a senha
        mostrarModalSenha(senha, () => {
          // Remove da fila e renderiza próximo
          filaSemAgendamento.shift();
          render();
        });
      }

      function pularCadastroSemAgendamento() {
        // Remove da fila sem registrar
        filaSemAgendamento.shift();
        render();
      }

      function confirmarESalvarSenhaSemAgendamento() {
        registrarSenhaSemAgendamento(window.senhaSemAgendamentoAtual).then(sucesso => {
          if (sucesso) {
            window.senhaSemAgendamentoRegistrada = true;
            const erroDiv = document.getElementById('erroSenhaSemAgendamento');
            if (erroDiv) {
              erroDiv.innerHTML = "";
            }
          }
        });
      }

      // Inicialização
      render();

      // Torna funções globais para uso nos botões inline
      window.proximoPasso = proximoPasso;
      window.tenhoAgendamento = tenhoAgendamento;
      window.naoTenhoAgendamento = naoTenhoAgendamento;
      window.buscarPaciente = buscarPaciente;
      window.confirmarAtendimento = confirmarAtendimento;
      window.voltarInicio = voltarInicio;
      window.voltarInicioSemAgendamento = voltarInicioSemAgendamento;
      window.abrirCadastroAtendente = abrirCadastroAtendente;
      window.registrarSemAgendamento = registrarSemAgendamento;
      window.pularCadastroSemAgendamento = pularCadastroSemAgendamento;
      window.confirmarESalvarSenhaSemAgendamento = confirmarESalvarSenhaSemAgendamento;

      // Adicione um botão para a atendente acessar a tela de cadastro (exemplo: F2)
      document.addEventListener('keydown', function(e) {
        if (e.key === 'F2') {
          abrirCadastroAtendente();
        }
      });
    </script>
  </body>
</html>
